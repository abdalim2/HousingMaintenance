(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[351],{2099:(e,t,i)=>{"use strict";i.d(t,{N:()=>r});let r=(0,i(851).UU)("zzzzz","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10aWN2bXlmcmRtY2lhZWlwZnh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwODc1OTMsImV4cCI6MjA1NjY2MzU5M30.6iudxBl6js0heW1mhoSmcXegTIN_lAN2GiFeA3plSIo")},2424:(e,t,i)=>{Promise.resolve().then(i.bind(i,3509))},3509:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>c});var r=i(5155),s=i(2115),a=i(5695),n=i(4268),l=i(6269),o=i(9684);function c(){let e=(0,a.useRouter)(),[t,i]=(0,s.useState)({complex_id:"",building_id:"",room_id:"",facility_id:"",reported_by:"",priority:"medium",description:""}),[c,d]=(0,s.useState)([]),[m,u]=(0,s.useState)([]),[h,p]=(0,s.useState)([]),[x,g]=(0,s.useState)([]),[b,f]=(0,s.useState)([]),[y,w]=(0,s.useState)([]),[j,_]=(0,s.useState)(!1),[v,N]=(0,s.useState)(null),[S,q]=(0,s.useState)(null);(0,s.useEffect)(()=>{(async()=>{_(!0);try{let e=[],t=[];try{e=await (0,n.l0)()}catch(e){console.error("Error fetching complexes:",e)}try{t=await (0,l.JS)()}catch(e){console.error("Error fetching items:",e)}d(e),f(t)}catch(e){console.error("Error in fetchInitialData:",e),N("حدث خطأ أثناء تحميل البيانات. الرجاء المحاولة مرة أخرى.")}finally{_(!1)}})()},[]),(0,s.useEffect)(()=>{t.complex_id&&(async()=>{try{let e=await (0,n.yS)(t.complex_id);u(e),i(e=>({...e,building_id:"",room_id:"",facility_id:""})),p([]),g([])}catch(e){console.error("Error fetching buildings:",e)}})()},[t.complex_id]),(0,s.useEffect)(()=>{t.building_id&&(async()=>{try{let[e,r]=await Promise.all([(0,n.t8)(t.building_id),(0,n.WL)(t.complex_id,t.building_id)]);p(e),g(r),i(e=>({...e,room_id:"",facility_id:""}))}catch(e){console.error("Error fetching rooms and facilities:",e)}})()},[t.building_id,t.complex_id]);let k=e=>{let{name:t,value:r}=e.target;i(e=>({...e,[t]:r}))},I=(e,t,i)=>{w(r=>r.map(r=>r.id===e?{...r,[t]:i}:r))},E=e=>{w(t=>t.filter(t=>t.id!==e))},C=async i=>{i.preventDefault(),_(!0),N(null),q(null);try{if(!t.complex_id||!t.building_id||!t.reported_by||!t.description)throw Error("الرجاء تعبئة جميع الحقول المطلوبة");let i=await (0,o.Dn)({complex_id:t.complex_id,building_id:t.building_id,room_id:t.room_id||void 0,facility_id:t.facility_id||void 0,reported_by:t.reported_by,priority:t.priority,description:t.description,status:"pending"}),r=y.map(e=>!e.item_id||e.quantity<1?null:(0,o.v)({maintenance_id:i.id,item_id:e.item_id,quantity_needed:e.quantity,notes:e.notes}));await Promise.all(r.filter(Boolean)),q("تم تقديم طلب الصيانة بنجاح"),setTimeout(()=>{e.push("/maintenance")},2e3)}catch(e){console.error("Error submitting maintenance request:",e),N(e.message||"حدث خطأ أثناء تقديم طلب الصيانة. الرجاء المحاولة مرة أخرى.")}finally{_(!1)}};return(0,r.jsxs)("div",{className:"container mx-auto",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold",children:"طلب صيانة جديد"}),(0,r.jsx)("button",{type:"button",onClick:()=>e.back(),className:"btn bg-gray-500 hover:bg-gray-600",children:"عودة"})]}),v&&(0,r.jsx)("div",{className:"bg-red-100 border-r-4 border-red-500 text-red-700 p-4 mb-6 rounded-md",children:(0,r.jsx)("p",{children:v})}),S&&(0,r.jsx)("div",{className:"bg-green-100 border-r-4 border-green-500 text-green-700 p-4 mb-6 rounded-md",children:(0,r.jsx)("p",{children:S})}),(0,r.jsxs)("form",{onSubmit:C,className:"bg-white shadow-md rounded-lg p-6",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block mb-2 font-medium",children:["المجمع السكني ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsxs)("select",{name:"complex_id",value:t.complex_id,onChange:k,className:"select w-full",required:!0,children:[(0,r.jsx)("option",{value:"",children:"اختر المجمع"}),c.map(e=>(0,r.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block mb-2 font-medium",children:["المبنى ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsxs)("select",{name:"building_id",value:t.building_id,onChange:k,className:"select w-full",disabled:!t.complex_id,required:!0,children:[(0,r.jsx)("option",{value:"",children:"اختر المبنى"}),m.map(e=>(0,r.jsx)("option",{value:e.id,children:e.name},e.id))]})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block mb-2 font-medium",children:"الغرفة"}),(0,r.jsxs)("select",{name:"room_id",value:t.room_id,onChange:k,className:"select w-full",disabled:!t.building_id,children:[(0,r.jsx)("option",{value:"",children:"اختر الغرفة"}),h.map(e=>(0,r.jsxs)("option",{value:e.id,children:["الطابق ",e.floor," - غرفة ",e.room_number," (",e.type,")"]},e.id))]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block mb-2 font-medium",children:"المرافق"}),(0,r.jsxs)("select",{name:"facility_id",value:t.facility_id,onChange:k,className:"select w-full",disabled:!t.building_id,children:[(0,r.jsx)("option",{value:"",children:"اختر المرافق"}),x.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.name," (",e.type,")"]},e.id))]})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block mb-2 font-medium",children:["مقدم الطلب ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsx)("input",{type:"text",name:"reported_by",value:t.reported_by,onChange:k,className:"input w-full",placeholder:"اسم مقدم الطلب",required:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block mb-2 font-medium",children:["الأولوية ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsxs)("select",{name:"priority",value:t.priority,onChange:k,className:"select w-full",required:!0,children:[(0,r.jsx)("option",{value:"low",children:"منخفضة"}),(0,r.jsx)("option",{value:"medium",children:"متوسطة"}),(0,r.jsx)("option",{value:"high",children:"عالية"}),(0,r.jsx)("option",{value:"emergency",children:"طارئة"})]})]})]}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsxs)("label",{className:"block mb-2 font-medium",children:["وصف المشكلة ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsx)("textarea",{name:"description",value:t.description,onChange:k,className:"input w-full h-32",placeholder:"اكتب وصفاً تفصيلياً للمشكلة...",required:!0})]}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsx)("h3",{className:"text-lg font-medium",children:"الأصناف المطلوبة"}),(0,r.jsx)("button",{type:"button",onClick:()=>{let e={id:Date.now().toString(),item_id:"",quantity:1,notes:""};w(t=>[...t,e])},className:"btn bg-secondary hover:bg-secondary/90",children:"إضافة صنف"})]}),0===y.length?(0,r.jsx)("p",{className:"text-gray-500 italic",children:"لم يتم إضافة أي أصناف بعد."}):(0,r.jsx)("div",{className:"space-y-4",children:y.map((e,t)=>(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-md border flex flex-wrap items-end gap-4",children:[(0,r.jsxs)("div",{className:"flex-grow min-w-[250px]",children:[(0,r.jsxs)("label",{className:"block mb-2 text-sm font-medium",children:["الصنف ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsxs)("select",{value:e.item_id,onChange:t=>I(e.id,"item_id",t.target.value),className:"select w-full",required:!0,children:[(0,r.jsx)("option",{value:"",children:"اختر الصنف"}),b.map(e=>(0,r.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,r.jsxs)("div",{className:"w-24",children:[(0,r.jsxs)("label",{className:"block mb-2 text-sm font-medium",children:["الكمية ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsx)("input",{type:"number",min:"1",value:e.quantity,onChange:t=>I(e.id,"quantity",parseInt(t.target.value)),className:"input w-full",required:!0})]}),(0,r.jsxs)("div",{className:"flex-grow min-w-[250px]",children:[(0,r.jsx)("label",{className:"block mb-2 text-sm font-medium",children:"ملاحظات"}),(0,r.jsx)("input",{type:"text",value:e.notes,onChange:t=>I(e.id,"notes",t.target.value),className:"input w-full",placeholder:"أي ملاحظات خاصة بالصنف..."})]}),(0,r.jsx)("button",{type:"button",onClick:()=>E(e.id),className:"bg-red-500 hover:bg-red-600 text-white px-2 py-2 rounded",children:(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]},e.id))})]}),(0,r.jsxs)("div",{className:"flex justify-end gap-4 mt-8",children:[(0,r.jsx)("button",{type:"button",onClick:()=>e.back(),className:"btn bg-gray-500 hover:bg-gray-600",disabled:j,children:"إلغاء"}),(0,r.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:j,children:j?"جاري الحفظ...":"تقديم طلب الصيانة"})]})]})]})}},4268:(e,t,i)=>{"use strict";i.d(t,{WL:()=>l,XI:()=>s,l0:()=>r,t8:()=>n,yS:()=>a});let r=async()=>{try{let e=await fetch("/api/housing");if(!e.ok)throw Error("فشل في جلب المجمعات السكنية: ".concat(e.statusText));return await e.json()}catch(e){throw console.error("فشل في جلب المجمعات السكنية:",e),e}},s=async e=>{console.log("محاولة إنشاء مجمع سكني جديد:",e);try{if(!e.name||!e.location)throw Error("اسم المجمع والموقع مطلوبان");let t=await fetch("/api/housing",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let e=await t.json();throw Error(e.error||"فشل في إنشاء المجمع السكني: ".concat(t.statusText))}let i=await t.json();return console.log("تم إنشاء المجمع بنجاح:",i),i}catch(e){throw console.error("خطأ غير متوقع عند إنشاء المجمع:",e),e}},a=async e=>{try{let t=await fetch(e?"/api/housing/buildings?complexId=".concat(e):"/api/housing/buildings");if(!t.ok)throw Error("فشل في جلب المباني: ".concat(t.statusText));return await t.json()}catch(e){throw console.error("فشل في جلب المباني:",e),e}},n=async e=>{try{let t=e?"/api/housing/rooms?buildingId=".concat(e):"/api/housing/rooms";console.log("Fetching rooms from ".concat(t));let i=await fetch(t,{cache:"no-store"});if(!i.ok){let e,t=await i.text();try{e=JSON.parse(t).error||i.statusText}catch(r){e=t||i.statusText}throw console.error("Error response from rooms API: ".concat(e)),Error("فشل في جلب الغرف: ".concat(e))}return(await i.json()).map(e=>({id:e.id,building_id:e.building_id,room_number:e.room_number,type:e.type,status:e.status||"available",floor:e.floor,name:e.room_number}))}catch(e){throw console.error("فشل في جلب الغرف:",e),e}},l=async(e,t)=>{try{let i="/api/housing/facilities",r=new URLSearchParams;e&&r.append("complexId",e),t&&r.append("buildingId",t),r.toString()&&(i+="?".concat(r.toString())),console.log("Fetching facilities from ".concat(i));let s=await fetch(i,{cache:"no-store"});if(!s.ok){let e,t=await s.text();try{e=JSON.parse(t).error||s.statusText}catch(i){e=t||s.statusText}throw console.error("Error response from facilities API: ".concat(e)),Error("فشل في جلب المرافق: ".concat(e))}return(await s.json()).map(e=>({id:e.id,complex_id:e.complex_id,building_id:e.building_id,name:e.name,type:e.type,location_description:e.location_description}))}catch(e){throw console.error("فشل في جلب المرافق:",e),e}}},5695:(e,t,i)=>{"use strict";var r=i(8999);i.o(r,"usePathname")&&i.d(t,{usePathname:function(){return r.usePathname}}),i.o(r,"useRouter")&&i.d(t,{useRouter:function(){return r.useRouter}})},6269:(e,t,i)=>{"use strict";i.d(t,{JS:()=>o,K7:()=>l,ZK:()=>c,bW:()=>s,d2:()=>m,st:()=>n,x8:()=>d,zZ:()=>a});var r=i(2099);let s=async()=>{let{data:e,error:t}=await r.N.from("categories").select("*");if(t)throw t;return e||[]},a=async e=>{let{data:t,error:i}=await r.N.from("categories").insert([e]).select().single();if(i)throw i;return t},n=async(e,t)=>{let{data:i,error:s}=await r.N.from("categories").update(t).eq("id",e).select().single();if(s)throw s;return i},l=async e=>{let{error:t}=await r.N.from("categories").delete().eq("id",e);if(t)throw t},o=async e=>{let t=r.N.from("items").select("*");e&&(t=t.eq("category_id",e));let{data:i,error:s}=await t;if(s)throw s;return i||[]},c=async e=>{let t=r.N.from("inventory").select("\n      *,\n      items:item_id (\n        id,\n        name,\n        category_id,\n        unit\n      )\n    ");e&&(t=t.eq("item_id",e));let{data:i,error:s}=await t;if(s)throw s;return i||[]},d=async(e,t)=>{let{data:i,error:s}=await r.N.from("inventory").select("*").eq("item_id",e).single();if(s&&"PGRST116"!==s.code)throw s;if(i){let e=i.quantity+t;if(e<0)throw Error("Insufficient inventory quantity");let{data:s,error:a}=await r.N.from("inventory").update({quantity:e,last_updated:new Date().toISOString()}).eq("id",i.id).select().single();if(a)throw a;return s}if(t>0){let{data:i,error:s}=await r.N.from("inventory").insert([{item_id:e,quantity:t,last_updated:new Date().toISOString()}]).select().single();if(s)throw s;return i}throw Error("Cannot reduce quantity of non-existent inventory item")},m=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,{data:t,error:i}=await r.N.from("inventory").select("\n      *,\n      items:item_id (\n        id,\n        name,\n        category_id,\n        unit\n      )\n    ").lte("quantity",e);if(i)throw i;return t||[]}},9684:(e,t,i)=>{"use strict";i.d(t,{Dn:()=>a,Om:()=>s,v:()=>n});var r=i(2099);let s=async(e,t,i)=>{try{let s=r.N.from("maintenance_requests").select("*");e&&(s=s.eq("complex_id",e)),t&&(s=s.eq("building_id",t)),i&&(s=s.eq("status",i));let{data:a,error:n}=await s.order("reported_date",{ascending:!1});if(n)throw console.error("Supabase error in getMaintenanceRequests:",n),n.message.includes("does not exist")&&console.warn("The maintenance_requests table might not exist yet. Make sure to run database initialization scripts."),Error("Database error: ".concat(n.message));return a||[]}catch(e){throw console.error("Error in getMaintenanceRequests:",e),e}},a=async e=>{let t={...e,reported_date:new Date().toISOString(),status:e.status||"pending"},{data:i,error:s}=await r.N.from("maintenance_requests").insert([t]).select().single();if(s)throw s;return i},n=async e=>{let{data:t,error:i}=await r.N.from("maintenance_items").insert([e]).select().single();if(i)throw i;return t}}},e=>{var t=t=>e(e.s=t);e.O(0,[851,441,684,358],()=>t(2424)),_N_E=e.O()}]);