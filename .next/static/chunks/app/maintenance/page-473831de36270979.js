(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[494],{2099:(e,t,r)=>{"use strict";r.d(t,{N:()=>a});let a=(0,r(851).UU)("https://mticvmyfrdmciaeipfxu.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10aWN2bXlmcmRtY2lhZWlwZnh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwODc1OTMsImV4cCI6MjA1NjY2MzU5M30.6iudxBl6js0heW1mhoSmcXegTIN_lAN2GiFeA3plSIo")},2168:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>c});var a=r(5155),s=r(2115),i=r(6874),n=r.n(i),o=r(9684),d=r(4268),l=r(2099);function c(){let[e,t]=(0,s.useState)([]),[r,i]=(0,s.useState)([]),[c,h]=(0,s.useState)([]),[p,u]=(0,s.useState)(!0),[m,b]=(0,s.useState)(null),[y,k]=(0,s.useState)({complexId:"",buildingId:"",status:"",priority:""}),w=async()=>{try{let{data:e,error:t}=await l.N.from("maintenance_requests").select("id").limit(1);if(t&&t.message.includes("does not exist")){console.log("جدول maintenance_requests غير موجود. سيتم إنشاؤه الآن...");let e=await fetch("/api/diagnostics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"setup_database"})});if(e.ok)console.log("تم إعداد قاعدة البيانات بنجاح");else{let t=await e.json();throw Error("فشل إعداد قاعدة البيانات: ".concat(t.error||"خطأ غير معروف"))}}else if(t)throw t;return!0}catch(e){return console.error("خطأ في التحقق من جدول maintenance_requests:",e),!1}};(0,s.useEffect)(()=>{(async()=>{try{let e=await (0,d.l0)();i(e)}catch(e){console.error("Error fetching complexes:",e)}})()},[]),(0,s.useEffect)(()=>{y.complexId?(async()=>{try{let e=await (0,d.yS)(y.complexId);h(e),k(e=>({...e,buildingId:""}))}catch(e){console.error("Error fetching buildings:",e)}})():h([])},[y.complexId]),(0,s.useEffect)(()=>{(async()=>{u(!0),b(null);try{await w();let e=await (0,o.Om)(y.complexId||void 0,y.buildingId||void 0,y.status||void 0),r=y.priority?e.filter(e=>e.priority===y.priority):e;t(r)}catch(e){console.error("Error fetching maintenance requests:",e),b("حدث خطأ أثناء تحميل البيانات: ".concat(e.message||"خطأ غير معروف",". الرجاء المحاولة مرة أخرى."))}finally{u(!1)}})()},[y]);let j=(e,t)=>{k(r=>({...r,[e]:t}))},f=async()=>{u(!0),b(null);try{let e=await fetch("/api/diagnostics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"setup_database"})});if(e.ok){let e=await (0,o.Om)();t(e)}else{let t=await e.json();throw Error("فشل إعداد قاعدة البيانات: ".concat(t.error||"خطأ غير معروف"))}}catch(e){console.error("Error setting up database:",e),b("فشل إعداد قاعدة البيانات: ".concat(e.message||"خطأ غير معروف"))}finally{u(!1)}};return(0,a.jsxs)("div",{className:"container mx-auto bg-gray-50 dark:bg-gray-900 min-h-screen p-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold dark:text-white",children:"طلبات الصيانة"}),(0,a.jsx)(n(),{href:"/maintenance/new",className:"btn btn-primary bg-teal-600 hover:bg-teal-700 text-white py-2 px-4 rounded dark:bg-teal-700 dark:hover:bg-teal-600",children:"طلب صيانة جديد"})]}),(0,a.jsxs)("div",{className:"bg-white shadow rounded-lg p-6 mb-6 dark:bg-gray-800",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold mb-4 dark:text-white",children:"تصفية النتائج"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium dark:text-gray-300",children:"المجمع السكني"}),(0,a.jsxs)("select",{value:y.complexId,onChange:e=>j("complexId",e.target.value),className:"select w-full border border-gray-300 rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:[(0,a.jsx)("option",{value:"",children:"جميع المجمعات"}),r.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium dark:text-gray-300",children:"المبنى"}),(0,a.jsxs)("select",{value:y.buildingId,onChange:e=>j("buildingId",e.target.value),className:"select w-full border border-gray-300 rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white",disabled:!y.complexId,children:[(0,a.jsx)("option",{value:"",children:"جميع المباني"}),c.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium dark:text-gray-300",children:"الحالة"}),(0,a.jsxs)("select",{value:y.status,onChange:e=>j("status",e.target.value),className:"select w-full border border-gray-300 rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:[(0,a.jsx)("option",{value:"",children:"جميع الحالات"}),(0,a.jsx)("option",{value:"pending",children:"معلق"}),(0,a.jsx)("option",{value:"approved",children:"معتمد"}),(0,a.jsx)("option",{value:"rejected",children:"مرفوض"}),(0,a.jsx)("option",{value:"in_progress",children:"قيد التنفيذ"}),(0,a.jsx)("option",{value:"completed",children:"مكتمل"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium dark:text-gray-300",children:"الأولوية"}),(0,a.jsxs)("select",{value:y.priority,onChange:e=>j("priority",e.target.value),className:"select w-full border border-gray-300 rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:[(0,a.jsx)("option",{value:"",children:"جميع الأولويات"}),(0,a.jsx)("option",{value:"low",children:"منخفضة"}),(0,a.jsx)("option",{value:"medium",children:"متوسطة"}),(0,a.jsx)("option",{value:"high",children:"عالية"}),(0,a.jsx)("option",{value:"emergency",children:"طارئة"})]})]})]}),(0,a.jsxs)("div",{className:"mt-4 flex justify-end",children:[(0,a.jsx)("button",{type:"button",onClick:()=>{k({complexId:"",buildingId:"",status:"",priority:""})},className:"btn bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded dark:bg-gray-600 dark:hover:bg-gray-700 mr-2",children:"إعادة تعيين التصفية"}),(0,a.jsx)("button",{type:"button",onClick:f,className:"btn bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded dark:bg-blue-700 dark:hover:bg-blue-600",children:"إعادة تهيئة قاعدة البيانات"})]})]}),m&&(0,a.jsx)("div",{className:"bg-red-100 border-r-4 border-red-500 text-red-700 p-4 mb-6 rounded-md dark:bg-red-900/30 dark:border-red-800 dark:text-red-400",children:(0,a.jsx)("p",{children:m})}),(0,a.jsx)("div",{className:"bg-white shadow-md rounded-lg overflow-hidden dark:bg-gray-800",children:p?(0,a.jsx)("div",{className:"text-center py-10 dark:text-gray-300",children:(0,a.jsx)("p",{className:"text-lg",children:"جاري تحميل البيانات..."})}):0===e.length?(0,a.jsx)("div",{className:"text-center py-10",children:(0,a.jsx)("p",{className:"text-lg text-gray-500 dark:text-gray-400",children:"لا توجد طلبات صيانة مطابقة للمعايير المحددة."})}):(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[(0,a.jsx)("thead",{className:"bg-gray-50 dark:bg-gray-700",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300",children:"رقم الطلب"}),(0,a.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300",children:"المجمع / المبنى"}),(0,a.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300",children:"الحالة"}),(0,a.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300",children:"الأولوية"}),(0,a.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300",children:"مقدم الطلب"}),(0,a.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300",children:"تاريخ الطلب"}),(0,a.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300",children:"إجراءات"})]})}),(0,a.jsx)("tbody",{className:"bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700",children:e.map(e=>(0,a.jsxs)("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700",children:[(0,a.jsx)("td",{className:"px-4 py-4 whitespace-nowrap dark:text-gray-300",children:e.id.substring(0,8)}),(0,a.jsxs)("td",{className:"px-4 py-4 whitespace-nowrap dark:text-gray-300",children:["المجمع: ",e.complex_id.substring(0,8),(0,a.jsx)("br",{}),"المبنى: ",e.building_id.substring(0,8)]}),(0,a.jsx)("td",{className:"px-4 py-4 whitespace-nowrap",children:(0,a.jsx)(x,{status:e.status})}),(0,a.jsx)("td",{className:"px-4 py-4 whitespace-nowrap",children:(0,a.jsx)(g,{priority:e.priority})}),(0,a.jsx)("td",{className:"px-4 py-4 whitespace-nowrap dark:text-gray-300",children:e.reported_by}),(0,a.jsx)("td",{className:"px-4 py-4 whitespace-nowrap dark:text-gray-300",dir:"ltr",children:new Date(e.reported_date).toLocaleDateString("ar-SA")}),(0,a.jsxs)("td",{className:"px-4 py-4 whitespace-nowrap text-sm",children:[(0,a.jsx)(n(),{href:"/maintenance/".concat(e.id),className:"text-blue-600 hover:underline ml-2 dark:text-blue-400",children:"عرض التفاصيل"}),(0,a.jsx)(n(),{href:"/maintenance/".concat(e.id,"/edit"),className:"text-teal-600 hover:underline dark:text-teal-400",children:"تحرير"})]})]},e.id))})]})})})]})}function x(e){let{status:t}=e,{bg:r,text:s,darkBg:i,darkText:n,label:o}={pending:{bg:"bg-yellow-100",text:"text-yellow-800",darkBg:"dark:bg-yellow-900/30",darkText:"dark:text-yellow-300",label:"معلق"},approved:{bg:"bg-blue-100",text:"text-blue-800",darkBg:"dark:bg-blue-900/30",darkText:"dark:text-blue-300",label:"معتمد"},rejected:{bg:"bg-red-100",text:"text-red-800",darkBg:"dark:bg-red-900/30",darkText:"dark:text-red-300",label:"مرفوض"},in_progress:{bg:"bg-purple-100",text:"text-purple-800",darkBg:"dark:bg-purple-900/30",darkText:"dark:text-purple-300",label:"قيد التنفيذ"},completed:{bg:"bg-green-100",text:"text-green-800",darkBg:"dark:bg-green-900/30",darkText:"dark:text-green-300",label:"مكتمل"}}[t];return(0,a.jsx)("span",{className:"".concat(r," ").concat(s," ").concat(i," ").concat(n," px-2 py-1 rounded-full text-xs"),children:o})}function g(e){let{priority:t}=e,{bg:r,text:s,darkBg:i,darkText:n,label:o}={low:{bg:"bg-green-100",text:"text-green-800",darkBg:"dark:bg-green-900/30",darkText:"dark:text-green-300",label:"منخفضة"},medium:{bg:"bg-blue-100",text:"text-blue-800",darkBg:"dark:bg-blue-900/30",darkText:"dark:text-blue-300",label:"متوسطة"},high:{bg:"bg-orange-100",text:"text-orange-800",darkBg:"dark:bg-orange-900/30",darkText:"dark:text-orange-300",label:"عالية"},emergency:{bg:"bg-red-100",text:"text-red-800",darkBg:"dark:bg-red-900/30",darkText:"dark:text-red-300",label:"طارئة"}}[t];return(0,a.jsx)("span",{className:"".concat(r," ").concat(s," ").concat(i," ").concat(n," px-2 py-1 rounded-full text-xs"),children:o})}},4268:(e,t,r)=>{"use strict";r.d(t,{WL:()=>o,XI:()=>s,l0:()=>a,t8:()=>n,yS:()=>i});let a=async()=>{try{let e=await fetch("/api/housing");if(!e.ok)throw Error("فشل في جلب المجمعات السكنية: ".concat(e.statusText));return await e.json()}catch(e){throw console.error("فشل في جلب المجمعات السكنية:",e),e}},s=async e=>{console.log("محاولة إنشاء مجمع سكني جديد:",e);try{if(!e.name||!e.location)throw Error("اسم المجمع والموقع مطلوبان");let t=await fetch("/api/housing",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let e=await t.json();throw Error(e.error||"فشل في إنشاء المجمع السكني: ".concat(t.statusText))}let r=await t.json();return console.log("تم إنشاء المجمع بنجاح:",r),r}catch(e){throw console.error("خطأ غير متوقع عند إنشاء المجمع:",e),e}},i=async e=>{try{let t=await fetch(e?"/api/housing/buildings?complexId=".concat(e):"/api/housing/buildings");if(!t.ok)throw Error("فشل في جلب المباني: ".concat(t.statusText));return await t.json()}catch(e){throw console.error("فشل في جلب المباني:",e),e}},n=async e=>{try{let t=e?"/api/housing/rooms?buildingId=".concat(e):"/api/housing/rooms";console.log("Fetching rooms from ".concat(t));let r=await fetch(t,{cache:"no-store"});if(!r.ok){let e,t=await r.text();try{e=JSON.parse(t).error||r.statusText}catch(a){e=t||r.statusText}throw console.error("Error response from rooms API: ".concat(e)),Error("فشل في جلب الغرف: ".concat(e))}return(await r.json()).map(e=>({id:e.id,building_id:e.building_id,room_number:e.room_number,type:e.type,status:e.status||"available",floor:e.floor,name:e.room_number}))}catch(e){throw console.error("فشل في جلب الغرف:",e),e}},o=async(e,t)=>{try{let r="/api/housing/facilities",a=new URLSearchParams;e&&a.append("complexId",e),t&&a.append("buildingId",t),a.toString()&&(r+="?".concat(a.toString())),console.log("Fetching facilities from ".concat(r));let s=await fetch(r,{cache:"no-store"});if(!s.ok){let e,t=await s.text();try{e=JSON.parse(t).error||s.statusText}catch(r){e=t||s.statusText}throw console.error("Error response from facilities API: ".concat(e)),Error("فشل في جلب المرافق: ".concat(e))}return(await s.json()).map(e=>({id:e.id,complex_id:e.complex_id,building_id:e.building_id,name:e.name,type:e.type,location_description:e.location_description}))}catch(e){throw console.error("فشل في جلب المرافق:",e),e}}},5734:(e,t,r)=>{Promise.resolve().then(r.bind(r,2168))},9684:(e,t,r)=>{"use strict";r.d(t,{Dn:()=>i,Om:()=>s,v:()=>n});var a=r(2099);let s=async(e,t,r)=>{try{let s=a.N.from("maintenance_requests").select("*");e&&(s=s.eq("complex_id",e)),t&&(s=s.eq("building_id",t)),r&&(s=s.eq("status",r));let{data:i,error:n}=await s.order("reported_date",{ascending:!1});if(n)throw console.error("Supabase error in getMaintenanceRequests:",n),n.message.includes("does not exist")&&console.warn("The maintenance_requests table might not exist yet. Make sure to run database initialization scripts."),Error("Database error: ".concat(n.message));return i||[]}catch(e){throw console.error("Error in getMaintenanceRequests:",e),e}},i=async e=>{let t={...e,reported_date:new Date().toISOString(),status:e.status||"pending"},{data:r,error:s}=await a.N.from("maintenance_requests").insert([t]).select().single();if(s)throw s;return r},n=async e=>{let{data:t,error:r}=await a.N.from("maintenance_items").insert([e]).select().single();if(r)throw r;return t}}},e=>{var t=t=>e(e.s=t);e.O(0,[851,874,441,684,358],()=>t(5734)),_N_E=e.O()}]);