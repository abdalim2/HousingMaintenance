(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[819],{796:(e,t,r)=>{Promise.resolve().then(r.bind(r,7233))},2099:(e,t,r)=>{"use strict";r.d(t,{N:()=>a});let a=(0,r(851).UU)("zzzzz","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10aWN2bXlmcmRtY2lhZWlwZnh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwODc1OTMsImV4cCI6MjA1NjY2MzU5M30.6iudxBl6js0heW1mhoSmcXegTIN_lAN2GiFeA3plSIo")},5695:(e,t,r)=>{"use strict";var a=r(8999);r.o(a,"usePathname")&&r.d(t,{usePathname:function(){return a.usePathname}}),r.o(a,"useRouter")&&r.d(t,{useRouter:function(){return a.useRouter}})},6269:(e,t,r)=>{"use strict";r.d(t,{JS:()=>o,K7:()=>d,ZK:()=>l,bW:()=>s,d2:()=>u,st:()=>n,x8:()=>c,zZ:()=>i});var a=r(2099);let s=async()=>{let{data:e,error:t}=await a.N.from("categories").select("*");if(t)throw t;return e||[]},i=async e=>{let{data:t,error:r}=await a.N.from("categories").insert([e]).select().single();if(r)throw r;return t},n=async(e,t)=>{let{data:r,error:s}=await a.N.from("categories").update(t).eq("id",e).select().single();if(s)throw s;return r},d=async e=>{let{error:t}=await a.N.from("categories").delete().eq("id",e);if(t)throw t},o=async e=>{let t=a.N.from("items").select("*");e&&(t=t.eq("category_id",e));let{data:r,error:s}=await t;if(s)throw s;return r||[]},l=async e=>{let t=a.N.from("inventory").select("\n      *,\n      items:item_id (\n        id,\n        name,\n        category_id,\n        unit\n      )\n    ");e&&(t=t.eq("item_id",e));let{data:r,error:s}=await t;if(s)throw s;return r||[]},c=async(e,t)=>{let{data:r,error:s}=await a.N.from("inventory").select("*").eq("item_id",e).single();if(s&&"PGRST116"!==s.code)throw s;if(r){let e=r.quantity+t;if(e<0)throw Error("Insufficient inventory quantity");let{data:s,error:i}=await a.N.from("inventory").update({quantity:e,last_updated:new Date().toISOString()}).eq("id",r.id).select().single();if(i)throw i;return s}if(t>0){let{data:r,error:s}=await a.N.from("inventory").insert([{item_id:e,quantity:t,last_updated:new Date().toISOString()}]).select().single();if(s)throw s;return r}throw Error("Cannot reduce quantity of non-existent inventory item")},u=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,{data:t,error:r}=await a.N.from("inventory").select("\n      *,\n      items:item_id (\n        id,\n        name,\n        category_id,\n        unit\n      )\n    ").lte("quantity",e);if(r)throw r;return t||[]}},7233:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>c});var a=r(5155),s=r(2115),i=r(5695),n=r(6874),d=r.n(n),o=r(8072),l=r(6269);function c(){let e=(0,i.useRouter)(),[t,r]=(0,s.useState)({vendor:"",notes:"",created_by:""}),[n,c]=(0,s.useState)([]),[u,m]=(0,s.useState)({item_id:"",quantity:1}),[g,h]=(0,s.useState)([]),[x,y]=(0,s.useState)([]),[b,p]=(0,s.useState)(""),[f,k]=(0,s.useState)(!1),[N,w]=(0,s.useState)(null),[j,v]=(0,s.useState)(null),[_,S]=(0,s.useState)(!1);(0,s.useEffect)(()=>{(async()=>{try{let e=await (0,l.bW)();h(e)}catch(e){console.error("Error fetching categories:",e),w(e.message||"فشل في تحميل التصنيفات")}})()},[]),(0,s.useEffect)(()=>{if(!b)return void y([]);(async()=>{S(!0);try{let e=await (0,l.JS)(b);y(e)}catch(e){console.error("Error fetching items:",e),w(e.message||"فشل في تحميل الأصناف")}finally{S(!1)}})()},[b]);let q=e=>{let{name:t,value:a}=e.target;r(e=>({...e,[t]:a}))},I=e=>{let{name:t,value:r}=e.target;if("item_id"===t&&r){let e=x.find(e=>e.id===r);m(a=>({...a,[t]:r,itemName:null==e?void 0:e.name,unit:null==e?void 0:e.unit}))}else m(e=>({...e,[t]:r}))},C=e=>{let t=[...n];t.splice(e,1),c(t)},O=()=>n.reduce((e,t)=>e+t.quantity*(t.unit_price||0),0),E=async r=>{if(r.preventDefault(),0===n.length)return void w("الرجاء إضافة صنف واحد على الأقل");if(!t.created_by.trim())return void w("الرجاء إدخال اسم منشئ الطلب");k(!0),w(null),v(null);try{let r={status:"draft",total_amount:O(),vendor:t.vendor.trim()||void 0,notes:t.notes.trim()||void 0,created_by:t.created_by.trim()},a=await (0,o.oC)(r);for(let e of n){let t={purchase_order_id:a.id,item_id:e.item_id,quantity:e.quantity,unit_price:e.unit_price,notes:e.notes};await (0,o.VE)(t)}v("تم إنشاء طلب الشراء بنجاح"),setTimeout(()=>{e.push("/purchase-orders/".concat(a.id))},2e3)}catch(e){console.error("Error creating purchase order:",e),w(e.message||"فشل في إنشاء طلب الشراء")}finally{k(!1)}};return(0,a.jsxs)("div",{className:"container mx-auto px-4 py-8 bg-gray-50 dark:bg-gray-900",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold dark:text-white",children:"إنشاء طلب شراء جديد"}),(0,a.jsx)(d(),{href:"/purchase-orders",className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600",children:"العودة لقائمة طلبات الشراء"})]}),N&&(0,a.jsx)("div",{className:"mb-6 p-4 bg-red-100 border-r-4 border-red-500 text-red-700 rounded-md dark:bg-red-900/30 dark:border-red-800 dark:text-red-400",children:N}),j&&(0,a.jsx)("div",{className:"mb-6 p-4 bg-green-100 border-r-4 border-green-500 text-green-700 rounded-md dark:bg-green-900/30 dark:border-green-800 dark:text-green-400",children:j}),(0,a.jsxs)("form",{onSubmit:E,children:[(0,a.jsxs)("div",{className:"bg-white shadow-md rounded-lg p-6 mb-6 dark:bg-gray-800",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4 dark:text-white",children:"بيانات الطلب"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium dark:text-gray-300",children:"المورد (اختياري)"}),(0,a.jsx)("input",{type:"text",name:"vendor",value:t.vendor,onChange:q,className:"w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",placeholder:"اسم المورد"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium dark:text-gray-300",children:"منشئ الطلب *"}),(0,a.jsx)("input",{type:"text",name:"created_by",value:t.created_by,onChange:q,required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",placeholder:"اسم منشئ الطلب"})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium dark:text-gray-300",children:"ملاحظات (اختياري)"}),(0,a.jsx)("textarea",{name:"notes",value:t.notes,onChange:q,rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",placeholder:"أي ملاحظات إضافية حول الطلب"})]})]})]}),(0,a.jsxs)("div",{className:"bg-white shadow-md rounded-lg p-6 mb-6 dark:bg-gray-800",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4 dark:text-white",children:"إضافة أصناف للطلب"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium dark:text-gray-300",children:"التصنيف"}),(0,a.jsxs)("select",{value:b,onChange:e=>p(e.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:[(0,a.jsx)("option",{value:"",children:"اختر التصنيف"}),g.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium dark:text-gray-300",children:"الصنف"}),(0,a.jsxs)("select",{name:"item_id",value:u.item_id,onChange:I,disabled:!b||_,className:"w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:[(0,a.jsx)("option",{value:"",children:"اختر الصنف"}),x.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.name," (",e.unit,")"]},e.id))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium dark:text-gray-300",children:"الكمية"}),(0,a.jsx)("input",{type:"number",name:"quantity",value:u.quantity,onChange:I,min:"1",className:"w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium dark:text-gray-300",children:"سعر الوحدة (اختياري)"}),(0,a.jsx)("input",{type:"number",name:"unit_price",value:u.unit_price||"",onChange:I,min:"0",step:"0.01",className:"w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",placeholder:"سعر الوحدة"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium dark:text-gray-300",children:"ملاحظات (اختياري)"}),(0,a.jsx)("input",{type:"text",name:"notes",value:u.notes||"",onChange:I,className:"w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",placeholder:"أي ملاحظات حول الصنف"})]}),(0,a.jsx)("div",{className:"flex items-end",children:(0,a.jsx)("button",{type:"button",onClick:()=>{if(!u.item_id)return void w("الرجاء اختيار صنف");if(u.quantity<=0)return void w("الكمية يجب أن تكون أكبر من صفر");let e=x.find(e=>e.id===u.item_id);if(!e)return void w("الصنف غير موجود");let t=n.findIndex(e=>e.item_id===u.item_id);if(t>=0){let e=[...n];e[t].quantity+=u.quantity,u.unit_price&&(e[t].unit_price=u.unit_price),u.notes&&(e[t].notes=u.notes),c(e)}else c([...n,{...u,itemName:e.name,unit:e.unit}]);m({item_id:"",quantity:1}),w(null)},disabled:!u.item_id||u.quantity<=0,className:"w-full px-4 py-2 text-white font-medium rounded-md\n                  ".concat(!u.item_id||u.quantity<=0?"bg-blue-300 cursor-not-allowed dark:bg-blue-800":"bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600","\n                "),children:"إضافة للطلب"})})]}),n.length>0?(0,a.jsxs)("div",{className:"mt-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium mb-3 dark:text-white",children:"قائمة الأصناف المطلوبة"}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full border-collapse",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"bg-gray-100 dark:bg-gray-700",children:[(0,a.jsx)("th",{className:"px-4 py-2 text-right text-gray-700 dark:text-gray-300",children:"#"}),(0,a.jsx)("th",{className:"px-4 py-2 text-right text-gray-700 dark:text-gray-300",children:"الصنف"}),(0,a.jsx)("th",{className:"px-4 py-2 text-right text-gray-700 dark:text-gray-300",children:"الكمية"}),(0,a.jsx)("th",{className:"px-4 py-2 text-right text-gray-700 dark:text-gray-300",children:"سعر الوحدة"}),(0,a.jsx)("th",{className:"px-4 py-2 text-right text-gray-700 dark:text-gray-300",children:"الإجمالي"}),(0,a.jsx)("th",{className:"px-4 py-2 text-right text-gray-700 dark:text-gray-300",children:"ملاحظات"}),(0,a.jsx)("th",{className:"px-4 py-2 text-right text-gray-700 dark:text-gray-300",children:"إجراءات"})]})}),(0,a.jsxs)("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-600",children:[n.map((e,t)=>(0,a.jsxs)("tr",{className:"dark:bg-gray-800",children:[(0,a.jsx)("td",{className:"px-4 py-3 dark:text-gray-300",children:t+1}),(0,a.jsxs)("td",{className:"px-4 py-3 dark:text-gray-300",children:[e.itemName," ",e.unit?"(".concat(e.unit,")"):""]}),(0,a.jsx)("td",{className:"px-4 py-3 dark:text-gray-300",children:e.quantity}),(0,a.jsx)("td",{className:"px-4 py-3 dark:text-gray-300",children:e.unit_price?"".concat(e.unit_price," ريال"):"-"}),(0,a.jsx)("td",{className:"px-4 py-3 dark:text-gray-300",children:e.unit_price?"".concat((e.quantity*e.unit_price).toFixed(2)," ريال"):"-"}),(0,a.jsx)("td",{className:"px-4 py-3 dark:text-gray-300",children:e.notes||"-"}),(0,a.jsx)("td",{className:"px-4 py-3",children:(0,a.jsx)("button",{type:"button",onClick:()=>C(t),className:"text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300",children:"حذف"})})]},t)),(0,a.jsxs)("tr",{className:"font-bold bg-gray-50 dark:bg-gray-700",children:[(0,a.jsx)("td",{className:"px-4 py-3 dark:text-gray-300",colSpan:4,children:"الإجمالي"}),(0,a.jsxs)("td",{className:"px-4 py-3 dark:text-gray-300",children:[O().toFixed(2)," ريال"]}),(0,a.jsx)("td",{className:"px-4 py-3",colSpan:2})]})]})]})})]}):(0,a.jsx)("div",{className:"mt-4 p-4 text-center text-gray-500 bg-gray-50 rounded-md dark:bg-gray-700 dark:text-gray-400",children:"لم تتم إضافة أي أصناف بعد"})]}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsx)("button",{type:"submit",disabled:0===n.length||f,className:"px-6 py-3 text-white font-medium rounded-md\n              ".concat(0===n.length||f?"bg-green-300 cursor-not-allowed dark:bg-green-800":"bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-600","\n            "),children:f?"جاري الإنشاء...":"إنشاء طلب الشراء"})})]})]})}},8072:(e,t,r)=>{"use strict";r.d(t,{LH:()=>s,VE:()=>n,_O:()=>d,oC:()=>i});var a=r(2099);let s=async e=>{try{let t=a.N.from("purchase_orders").select("*");e&&(t=t.eq("status",e));let{data:r,error:s}=await t.order("order_date",{ascending:!1});if(s)throw console.error("Supabase error in getPurchaseOrders:",s),s.message.includes("does not exist")&&console.warn("The purchase_orders table might not exist yet. Make sure to run database initialization scripts."),Error("Database error: ".concat(s.message));return r||[]}catch(e){throw console.error("Error in getPurchaseOrders:",e),e}},i=async e=>{let t={...e,order_date:new Date().toISOString(),status:e.status||"draft"},{data:r,error:s}=await a.N.from("purchase_orders").insert([t]).select().single();if(s)throw s;return r},n=async e=>{let{data:t,error:r}=await a.N.from("purchase_items").insert([e]).select().single();if(r)throw r;return t},d=async(e,t,r)=>{try{let s=new Date(e,t-1,1).toISOString(),i=new Date(e,t,0).toISOString(),{data:n,error:d}=await a.N.from("maintenance_requests").select("id").gte("reported_date",s).lte("reported_date",i);if(d){if(d.message.includes("does not exist"))return console.warn("Maintenance requests table does not exist yet. Creating empty purchase order."),o(e,t,r);throw d}if(!n||0===n.length)return console.log("No maintenance requests found for the specified month. Creating empty purchase order."),o(e,t,r);let l=n.map(e=>e.id),{data:c,error:u}=await a.N.from("maintenance_items").select("*").in("maintenance_id",l);if(u){if(u.message.includes("does not exist"))return console.warn("Maintenance items table does not exist yet. Creating empty purchase order."),o(e,t,r);throw u}if(!c||0===c.length)return console.log("No maintenance items found for the specified month. Creating empty purchase order."),o(e,t,r);let m={};c.forEach(e=>{m[e.item_id]||(m[e.item_id]=0),m[e.item_id]+=e.quantity_needed});let{data:g,error:h}=await a.N.from("purchase_orders").insert([{order_date:new Date().toISOString(),status:"draft",created_by:r,notes:"Auto-generated order for ".concat(e,"-").concat(t.toString().padStart(2,"0"))}]).select().single();if(h)throw h;if(Object.keys(m).length>0){let e=Object.entries(m).map(e=>{let[t,r]=e;return{purchase_order_id:g.id,item_id:t,quantity:r}}),{error:t}=await a.N.from("purchase_items").insert(e);if(t)throw t}return g}catch(e){throw console.error("Error generating monthly purchase order:",e),e}},o=async(e,t,r)=>{let{data:s,error:i}=await a.N.from("purchase_orders").insert([{order_date:new Date().toISOString(),status:"draft",created_by:r,notes:"Auto-generated order for ".concat(e,"-").concat(t.toString().padStart(2,"0")," (No maintenance items found)")}]).select().single();if(i)throw i;return s}}},e=>{var t=t=>e(e.s=t);e.O(0,[851,874,441,684,358],()=>t(796)),_N_E=e.O()}]);