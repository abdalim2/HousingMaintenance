(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[696],{2099:(e,t,r)=>{"use strict";r.d(t,{N:()=>a});let a=(0,r(851).UU)("zzzzz","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10aWN2bXlmcmRtY2lhZWlwZnh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwODc1OTMsImV4cCI6MjA1NjY2MzU5M30.6iudxBl6js0heW1mhoSmcXegTIN_lAN2GiFeA3plSIo")},2839:(e,t,r)=>{Promise.resolve().then(r.bind(r,8794))},5695:(e,t,r)=>{"use strict";var a=r(8999);r.o(a,"usePathname")&&r.d(t,{usePathname:function(){return a.usePathname}}),r.o(a,"useRouter")&&r.d(t,{useRouter:function(){return a.useRouter}})},8072:(e,t,r)=>{"use strict";r.d(t,{LH:()=>s,VE:()=>l,_O:()=>i,oC:()=>n});var a=r(2099);let s=async e=>{try{let t=a.N.from("purchase_orders").select("*");e&&(t=t.eq("status",e));let{data:r,error:s}=await t.order("order_date",{ascending:!1});if(s)throw console.error("Supabase error in getPurchaseOrders:",s),s.message.includes("does not exist")&&console.warn("The purchase_orders table might not exist yet. Make sure to run database initialization scripts."),Error("Database error: ".concat(s.message));return r||[]}catch(e){throw console.error("Error in getPurchaseOrders:",e),e}},n=async e=>{let t={...e,order_date:new Date().toISOString(),status:e.status||"draft"},{data:r,error:s}=await a.N.from("purchase_orders").insert([t]).select().single();if(s)throw s;return r},l=async e=>{let{data:t,error:r}=await a.N.from("purchase_items").insert([e]).select().single();if(r)throw r;return t},i=async(e,t,r)=>{try{let s=new Date(e,t-1,1).toISOString(),n=new Date(e,t,0).toISOString(),{data:l,error:i}=await a.N.from("maintenance_requests").select("id").gte("reported_date",s).lte("reported_date",n);if(i){if(i.message.includes("does not exist"))return console.warn("Maintenance requests table does not exist yet. Creating empty purchase order."),o(e,t,r);throw i}if(!l||0===l.length)return console.log("No maintenance requests found for the specified month. Creating empty purchase order."),o(e,t,r);let c=l.map(e=>e.id),{data:d,error:u}=await a.N.from("maintenance_items").select("*").in("maintenance_id",c);if(u){if(u.message.includes("does not exist"))return console.warn("Maintenance items table does not exist yet. Creating empty purchase order."),o(e,t,r);throw u}if(!d||0===d.length)return console.log("No maintenance items found for the specified month. Creating empty purchase order."),o(e,t,r);let m={};d.forEach(e=>{m[e.item_id]||(m[e.item_id]=0),m[e.item_id]+=e.quantity_needed});let{data:h,error:b}=await a.N.from("purchase_orders").insert([{order_date:new Date().toISOString(),status:"draft",created_by:r,notes:"Auto-generated order for ".concat(e,"-").concat(t.toString().padStart(2,"0"))}]).select().single();if(b)throw b;if(Object.keys(m).length>0){let e=Object.entries(m).map(e=>{let[t,r]=e;return{purchase_order_id:h.id,item_id:t,quantity:r}}),{error:t}=await a.N.from("purchase_items").insert(e);if(t)throw t}return h}catch(e){throw console.error("Error generating monthly purchase order:",e),e}},o=async(e,t,r)=>{let{data:s,error:n}=await a.N.from("purchase_orders").insert([{order_date:new Date().toISOString(),status:"draft",created_by:r,notes:"Auto-generated order for ".concat(e,"-").concat(t.toString().padStart(2,"0")," (No maintenance items found)")}]).select().single();if(n)throw n;return s}},8794:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>c});var a=r(5155),s=r(2115),n=r(5695),l=r(6874),i=r.n(l),o=r(8072);function c(){let e=(0,n.useRouter)(),[t,r]=(0,s.useState)(new Date().getFullYear()),[l,c]=(0,s.useState)(new Date().getMonth()+1),[d,u]=(0,s.useState)(""),[m,h]=(0,s.useState)(!1),[b,f]=(0,s.useState)(null),p=new Date().getFullYear(),g=async r=>{if(r.preventDefault(),!d.trim())return void f("الرجاء إدخال اسم منشئ الطلب");h(!0),f(null);try{let r=await (0,o._O)(t,l,d);e.push("/purchase-orders/".concat(r.id))}catch(e){console.error("Error generating monthly purchase order:",e),f(e.message||"حدث خطأ أثناء إنشاء طلب الشراء الشهري"),h(!1)}};return(0,a.jsxs)("div",{className:"container mx-auto",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold",children:"إنشاء طلب شراء شهري"}),(0,a.jsx)(i(),{href:"/purchase-orders",className:"btn btn-secondary",children:"العودة لقائمة طلبات الشراء"})]}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("p",{className:"mb-6 text-gray-600",children:"سيقوم النظام بإنشاء طلب شراء يتضمن جميع المواد المطلوبة لطلبات الصيانة المسجلة خلال الشهر المحدد."}),b&&(0,a.jsx)("div",{className:"bg-red-100 border-r-4 border-red-500 text-red-700 p-4 mb-6 rounded-md",children:(0,a.jsx)("p",{children:b})}),(0,a.jsxs)("form",{onSubmit:g,children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium",children:"السنة"}),(0,a.jsx)("select",{value:t,onChange:e=>r(Number(e.target.value)),className:"select w-full",disabled:m,children:[p,p-1,p-2].map(e=>(0,a.jsx)("option",{value:e,children:e},e))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium",children:"الشهر"}),(0,a.jsx)("select",{value:l,onChange:e=>c(Number(e.target.value)),className:"select w-full",disabled:m,children:[{value:1,label:"يناير"},{value:2,label:"فبراير"},{value:3,label:"مارس"},{value:4,label:"أبريل"},{value:5,label:"مايو"},{value:6,label:"يونيو"},{value:7,label:"يوليو"},{value:8,label:"أغسطس"},{value:9,label:"سبتمبر"},{value:10,label:"أكتوبر"},{value:11,label:"نوفمبر"},{value:12,label:"ديسمبر"}].map(e=>(0,a.jsx)("option",{value:e.value,children:e.label},e.value))})]})]}),(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("label",{className:"block mb-2 text-sm font-medium",children:"منشئ الطلب"}),(0,a.jsx)("input",{type:"text",value:d,onChange:e=>u(e.target.value),className:"input w-full",placeholder:"أدخل اسمك هنا",disabled:m,required:!0})]}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:m,children:m?"جاري الإنشاء...":"إنشاء طلب الشراء الشهري"})})]})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[851,874,441,684,358],()=>t(2839)),_N_E=e.O()}]);