(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[290],{2099:(e,t,r)=>{"use strict";r.d(t,{N:()=>s});let s=(0,r(851).UU)("zzzzz","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10aWN2bXlmcmRtY2lhZWlwZnh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwODc1OTMsImV4cCI6MjA1NjY2MzU5M30.6iudxBl6js0heW1mhoSmcXegTIN_lAN2GiFeA3plSIo")},8072:(e,t,r)=>{"use strict";r.d(t,{LH:()=>a,VE:()=>l,_O:()=>i,oC:()=>n});var s=r(2099);let a=async e=>{try{let t=s.N.from("purchase_orders").select("*");e&&(t=t.eq("status",e));let{data:r,error:a}=await t.order("order_date",{ascending:!1});if(a)throw console.error("Supabase error in getPurchaseOrders:",a),a.message.includes("does not exist")&&console.warn("The purchase_orders table might not exist yet. Make sure to run database initialization scripts."),Error("Database error: ".concat(a.message));return r||[]}catch(e){throw console.error("Error in getPurchaseOrders:",e),e}},n=async e=>{let t={...e,order_date:new Date().toISOString(),status:e.status||"draft"},{data:r,error:a}=await s.N.from("purchase_orders").insert([t]).select().single();if(a)throw a;return r},l=async e=>{let{data:t,error:r}=await s.N.from("purchase_items").insert([e]).select().single();if(r)throw r;return t},i=async(e,t,r)=>{try{let a=new Date(e,t-1,1).toISOString(),n=new Date(e,t,0).toISOString(),{data:l,error:i}=await s.N.from("maintenance_requests").select("id").gte("reported_date",a).lte("reported_date",n);if(i){if(i.message.includes("does not exist"))return console.warn("Maintenance requests table does not exist yet. Creating empty purchase order."),d(e,t,r);throw i}if(!l||0===l.length)return console.log("No maintenance requests found for the specified month. Creating empty purchase order."),d(e,t,r);let c=l.map(e=>e.id),{data:o,error:m}=await s.N.from("maintenance_items").select("*").in("maintenance_id",c);if(m){if(m.message.includes("does not exist"))return console.warn("Maintenance items table does not exist yet. Creating empty purchase order."),d(e,t,r);throw m}if(!o||0===o.length)return console.log("No maintenance items found for the specified month. Creating empty purchase order."),d(e,t,r);let h={};o.forEach(e=>{h[e.item_id]||(h[e.item_id]=0),h[e.item_id]+=e.quantity_needed});let{data:x,error:u}=await s.N.from("purchase_orders").insert([{order_date:new Date().toISOString(),status:"draft",created_by:r,notes:"Auto-generated order for ".concat(e,"-").concat(t.toString().padStart(2,"0"))}]).select().single();if(u)throw u;if(Object.keys(h).length>0){let e=Object.entries(h).map(e=>{let[t,r]=e;return{purchase_order_id:x.id,item_id:t,quantity:r}}),{error:t}=await s.N.from("purchase_items").insert(e);if(t)throw t}return x}catch(e){throw console.error("Error generating monthly purchase order:",e),e}},d=async(e,t,r)=>{let{data:a,error:n}=await s.N.from("purchase_orders").insert([{order_date:new Date().toISOString(),status:"draft",created_by:r,notes:"Auto-generated order for ".concat(e,"-").concat(t.toString().padStart(2,"0")," (No maintenance items found)")}]).select().single();if(n)throw n;return a}},8074:(e,t,r)=>{Promise.resolve().then(r.bind(r,8327))},8327:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>d});var s=r(5155),a=r(2115),n=r(6874),l=r.n(n),i=r(8072);function d(){let[e,t]=(0,a.useState)([]),[r,n]=(0,a.useState)(!0),[d,o]=(0,a.useState)(null),[m,h]=(0,a.useState)(""),[x,u]=(0,a.useState)({start:"",end:""});(0,a.useEffect)(()=>{(async()=>{n(!0),o(null);try{let e=await (0,i.LH)(m||void 0);t(e)}catch(e){console.error("Error fetching purchase orders:",e.message||JSON.stringify(e)),o("حدث خطأ أثناء تحميل طلبات الشراء: ".concat(e.message||"خطأ غير معروف",". الرجاء المحاولة مرة أخرى."))}finally{n(!1)}})()},[m]);let g=e.filter(e=>{let t=!0;return x.start&&(t=t&&new Date(e.order_date)>=new Date(x.start)),x.end&&(t=t&&new Date(e.order_date)<=new Date(x.end)),t}),p=e.filter(e=>"draft"===e.status||"submitted"===e.status).length,b=e.filter(e=>"received"===e.status).length,f=e.filter(e=>"completed"===e.status).length,j=new Date,N=j.getMonth(),y=j.getFullYear(),w=e.filter(e=>{let t=new Date(e.order_date);return t.getMonth()===N&&t.getFullYear()===y});return(0,s.jsxs)("div",{className:"container mx-auto",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold",children:"طلبات الشراء"}),(0,s.jsxs)("div",{className:"flex gap-3",children:[(0,s.jsx)(l(),{href:"/purchase-orders/monthly",className:"btn btn-secondary",children:"إنشاء طلب شهري"}),(0,s.jsx)(l(),{href:"/purchase-orders/new",className:"btn btn-primary",children:"إنشاء طلب شراء"})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8",children:[(0,s.jsxs)("div",{className:"card bg-white",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-700",children:"إجمالي الطلبات"}),(0,s.jsx)("p",{className:"mt-2 text-3xl font-bold",children:e.length})]}),(0,s.jsxs)("div",{className:"card bg-yellow-50 border-r-4 border-yellow-500",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-700",children:"طلبات معلقة"}),(0,s.jsx)("p",{className:"mt-2 text-3xl font-bold",children:p})]}),(0,s.jsxs)("div",{className:"card bg-blue-50 border-r-4 border-blue-500",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-700",children:"تم الاستلام"}),(0,s.jsx)("p",{className:"mt-2 text-3xl font-bold",children:b})]}),(0,s.jsxs)("div",{className:"card bg-green-50 border-r-4 border-green-500",children:[(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-700",children:"مكتملة"}),(0,s.jsx)("p",{className:"mt-2 text-3xl font-bold",children:f})]})]}),d&&(0,s.jsx)("div",{className:"bg-red-100 border-r-4 border-red-500 text-red-700 p-4 mb-6 rounded-md",children:(0,s.jsx)("p",{children:d})}),(0,s.jsxs)("div",{className:"bg-white shadow rounded-lg p-6 mb-6",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"تصفية طلبات الشراء"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block mb-2 text-sm font-medium",children:"الحالة"}),(0,s.jsxs)("select",{value:m,onChange:e=>h(e.target.value),className:"select w-full",children:[(0,s.jsx)("option",{value:"",children:"جميع الحالات"}),(0,s.jsx)("option",{value:"draft",children:"مسودة"}),(0,s.jsx)("option",{value:"submitted",children:"مقدم"}),(0,s.jsx)("option",{value:"approved",children:"معتمد"}),(0,s.jsx)("option",{value:"ordered",children:"تم الطلب"}),(0,s.jsx)("option",{value:"received",children:"تم الاستلام"}),(0,s.jsx)("option",{value:"completed",children:"مكتمل"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block mb-2 text-sm font-medium",children:"من تاريخ"}),(0,s.jsx)("input",{type:"date",value:x.start,onChange:e=>u({...x,start:e.target.value}),className:"input w-full"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block mb-2 text-sm font-medium",children:"إلى تاريخ"}),(0,s.jsx)("input",{type:"date",value:x.end,onChange:e=>u({...x,end:e.target.value}),className:"input w-full"})]})]})]}),(0,s.jsxs)("div",{className:"bg-white shadow-md rounded-lg p-6 mb-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,s.jsxs)("h2",{className:"text-lg font-semibold",children:["طلبات الشهر الحالي (",w.length,")"]}),w.length>0&&(0,s.jsx)(l(),{href:"/reports/monthly/".concat(y,"/").concat(N+1),className:"text-primary hover:underline",children:"عرض التقرير الشهري"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[w.slice(0,3).map(e=>(0,s.jsxs)("div",{className:"border rounded-md p-4 hover:bg-gray-50",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,s.jsxs)("h3",{className:"font-medium",children:["طلب #",e.id.substring(0,8)]}),(0,s.jsx)(c,{status:e.status})]}),(0,s.jsx)("p",{className:"text-gray-600 text-sm mb-2",dir:"ltr",children:new Date(e.order_date).toLocaleDateString("ar-SA")}),(0,s.jsx)("p",{className:"text-gray-700",children:e.total_amount?"".concat(e.total_amount," ريال"):"المبلغ غير محدد"}),(0,s.jsx)("div",{className:"mt-3",children:(0,s.jsx)(l(),{href:"/purchase-orders/".concat(e.id),className:"text-primary hover:underline text-sm",children:"عرض التفاصيل"})})]},e.id)),0===w.length&&(0,s.jsx)("div",{className:"col-span-3 bg-gray-50 p-4 rounded-md text-center text-gray-500",children:"لا توجد طلبات شراء لهذا الشهر"})]})]}),(0,s.jsxs)("div",{className:"bg-white shadow-md rounded-lg overflow-hidden",children:[(0,s.jsx)("div",{className:"p-4 bg-gray-50 border-b",children:(0,s.jsx)("h2",{className:"font-semibold text-lg",children:"جميع طلبات الشراء"})}),r?(0,s.jsx)("div",{className:"text-center py-10",children:(0,s.jsx)("p",{className:"text-lg",children:"جاري تحميل البيانات..."})}):0===g.length?(0,s.jsx)("div",{className:"text-center py-10",children:(0,s.jsx)("p",{className:"text-lg text-gray-500",children:"لا توجد طلبات شراء مطابقة للمعايير المحددة."})}):(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"رقم الطلب"}),(0,s.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"التاريخ"}),(0,s.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الحالة"}),(0,s.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"المبلغ الإجمالي"}),(0,s.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"المورد"}),(0,s.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"منشئ الطلب"}),(0,s.jsx)("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"إجراءات"})]})}),(0,s.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:g.map(e=>(0,s.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,s.jsxs)("td",{className:"px-4 py-4 whitespace-nowrap",children:["#",e.id.substring(0,8)]}),(0,s.jsx)("td",{className:"px-4 py-4 whitespace-nowrap",dir:"ltr",children:new Date(e.order_date).toLocaleDateString("ar-SA")}),(0,s.jsx)("td",{className:"px-4 py-4 whitespace-nowrap",children:(0,s.jsx)(c,{status:e.status})}),(0,s.jsx)("td",{className:"px-4 py-4 whitespace-nowrap",children:e.total_amount?"".concat(e.total_amount," ريال"):"غير محدد"}),(0,s.jsx)("td",{className:"px-4 py-4 whitespace-nowrap",children:e.vendor||"غير محدد"}),(0,s.jsx)("td",{className:"px-4 py-4 whitespace-nowrap",children:e.created_by}),(0,s.jsxs)("td",{className:"px-4 py-4 whitespace-nowrap text-sm",children:[(0,s.jsx)(l(),{href:"/purchase-orders/".concat(e.id),className:"text-secondary hover:underline ml-2",children:"عرض"}),("draft"===e.status||"submitted"===e.status)&&(0,s.jsx)(l(),{href:"/purchase-orders/".concat(e.id,"/edit"),className:"text-primary hover:underline ml-2",children:"تحرير"}),"ordered"===e.status&&(0,s.jsx)(l(),{href:"/purchase-orders/".concat(e.id,"/receive"),className:"text-accent hover:underline",children:"استلام"})]})]},e.id))})]})})]})]})}function c(e){let{status:t}=e,{bg:r,text:a,label:n}={draft:{bg:"bg-gray-100",text:"text-gray-800",label:"مسودة"},submitted:{bg:"bg-blue-100",text:"text-blue-800",label:"مقدم"},approved:{bg:"bg-green-100",text:"text-green-800",label:"معتمد"},ordered:{bg:"bg-purple-100",text:"text-purple-800",label:"تم الطلب"},received:{bg:"bg-yellow-100",text:"text-yellow-800",label:"تم الاستلام"},completed:{bg:"bg-green-100",text:"text-green-800",label:"مكتمل"}}[t]||{bg:"bg-gray-100",text:"text-gray-800",label:t};return(0,s.jsx)("span",{className:"".concat(r," ").concat(a," px-2 py-1 rounded-full text-xs"),children:n})}}},e=>{var t=t=>e(e.s=t);e.O(0,[851,874,441,684,358],()=>t(8074)),_N_E=e.O()}]);